name: CD - Continuous Deployment

on:
  workflow_run:
    workflows: ["CI - Continuous Integration"]
    types:
      - completed
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'
  RAILWAY_SERVICE_NAME: 'the-office-api'
  RAILWAY_URL: 'https://the-office-api.up.railway.app'

jobs:
  # Job 1: Check CI Status
  check-ci-status:
    runs-on: ubuntu-latest
    name: Check CI Status
    
    steps:
      - name: Check if CI passed
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "FAILED: CI pipeline failed - skipping deployment"
          exit 1

      - name: CI passed
        run: |
          echo "SUCCESS: CI pipeline passed - proceeding with deployment"

  # Job 2: Deploy to Railway
  deploy-to-railway:
    runs-on: ubuntu-latest
    name: Deploy to Railway
    needs: check-ci-status
    environment:
      name: production
      url: ${{ env.RAILWAY_URL }}/swagger
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying to Railway..."
          railway up --service=${{ env.RAILWAY_SERVICE_NAME }}
          echo "Deployment triggered successfully"

      - name: Wait for deployment
        run: |
          echo "Waiting 45 seconds for Railway deployment to stabilize..."
          sleep 45

  # Job 3: Health Check
  health-check:
    runs-on: ubuntu-latest
    name: Health Check
    needs: deploy-to-railway
    
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check API health
        run: |
          echo "Checking Railway deployment health..."
          
          success=false
          for i in {1..12}; do
            if curl -f -s "${{ env.RAILWAY_URL }}/swagger/index.html" > /dev/null; then
              echo "SUCCESS: API is responding (attempt $i)"
              success=true
              break
            fi
            echo "Waiting for API... (attempt $i/12)"
            sleep 10
          done
          
          if [ "$success" = false ]; then
            echo "FAILED: Health check failed - API not responding after 2 minutes"
            exit 1
          fi

      - name: Verify Swagger endpoints
        run: |
          echo "Verifying Swagger endpoints..."
          
          # Check Swagger UI
          if curl -f -s "${{ env.RAILWAY_URL }}/swagger/index.html" > /dev/null; then
            echo "SUCCESS: Swagger UI is accessible"
          else
            echo "FAILED: Swagger UI is not accessible"
            exit 1
          fi
          
          # Check and validate Swagger JSON
          if curl -f -s "${{ env.RAILWAY_URL }}/swagger/v1/swagger.json" | jq . > /dev/null 2>&1; then
            echo "SUCCESS: Swagger JSON is valid"
          else
            echo "FAILED: Swagger JSON is invalid or not accessible"
            exit 1
          fi
          
          echo ""
          echo "Health check passed!"

  # Job 4: Live Integration Tests
  live-integration-tests:
    runs-on: ubuntu-latest
    name: Live Integration Tests
    needs: health-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore TheOfficeAPI.sln

      - name: Build solution
        run: dotnet build TheOfficeAPI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run health check integration tests
        run: dotnet test tests/TheOfficeAPI.Level0.Tests.Integration/TheOfficeAPI.Level0.Tests.Integration.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --filter "Category=HealthCheck"
        env:
          ASPNETCORE_ENVIRONMENT: Production
          API_BASE_URL: ${{ env.RAILWAY_URL }}
        continue-on-error: true

      - name: Run documentation integration tests
        run: dotnet test tests/TheOfficeAPI.Level0.Tests.Integration/TheOfficeAPI.Level0.Tests.Integration.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --filter "Category=Documentation"
        env:
          ASPNETCORE_ENVIRONMENT: Production
          API_BASE_URL: ${{ env.RAILWAY_URL }}
        continue-on-error: true

      - name: Publish live integration test results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Live Integration Test Results
          path: '**/*.trx'
          reporter: dotnet-trx

  # Job 5: Smoke Tests (basic endpoint tests)
  smoke-tests:
    runs-on: ubuntu-latest
    name: Smoke Tests
    needs: health-check
    
    steps:
      - name: Test API endpoints
        run: |
          echo "Running smoke tests on Railway API..."
          
          # Test Swagger endpoints
          echo "Testing /swagger..."
          curl -f -s "${{ env.RAILWAY_URL }}/swagger/index.html" > /dev/null || exit 1
          echo "SUCCESS: Swagger UI works"
          
          curl -f -s "${{ env.RAILWAY_URL }}/swagger/v1/swagger.json" > /dev/null || exit 1
          echo "SUCCESS: Swagger JSON works"
          
          # Add tests for your endpoints here
          # echo "Testing /api/characters..."
          # curl -f -s "${{ env.RAILWAY_URL }}/api/characters" > /dev/null || exit 1
          # echo "SUCCESS: /api/characters works"
          
          echo ""
          echo "All smoke tests passed!"

  # Job 6: CD Summary
  cd-summary:
    runs-on: ubuntu-latest
    name: CD Summary
    needs: [check-ci-status, deploy-to-railway, health-check, live-integration-tests, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.smoke-tests.result == 'success'
        run: |
          echo "=================================================="
          echo "CD Pipeline - Deployment Successful!"
          echo "=================================================="
          echo ""
          echo "Deployment: SUCCESS"
          echo "Health Check: PASSED"
          echo "Live Integration Tests: PASSED"
          echo "Smoke Tests: PASSED"
          echo ""
          echo "Live API: ${{ env.RAILWAY_URL }}/swagger"
          echo "Swagger UI: ${{ env.RAILWAY_URL }}/swagger"
          echo "OpenAPI Spec: ${{ env.RAILWAY_URL }}/swagger/v1/swagger.json"
          echo ""
          echo "Environment: production"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Deployment Failure
        if: |
          needs.deploy-to-railway.result == 'failure' ||
          needs.health-check.result == 'failure' ||
          needs.live-integration-tests.result == 'failure' ||
          needs.smoke-tests.result == 'failure'
        run: |
          echo "=================================================="
          echo "CD Pipeline - Deployment Failed!"
          echo "=================================================="
          echo ""
          echo "Failed stages:"
          [ "${{ needs.deploy-to-railway.result }}" == "failure" ] && echo "FAILED: Deployment to Railway"
          [ "${{ needs.health-check.result }}" == "failure" ] && echo "FAILED: Health Check"
          [ "${{ needs.live-integration-tests.result }}" == "failure" ] && echo "FAILED: Live Integration Tests"
          [ "${{ needs.smoke-tests.result }}" == "failure" ] && echo "FAILED: Smoke Tests"
          echo ""
          echo "Check the logs above for details"
          exit 1