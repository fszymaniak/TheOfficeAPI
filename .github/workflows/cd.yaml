name: CD - Continuous Deployment

on:
  workflow_run:
    workflows: ["CI - Continuous Integration"]
    types:
      - completed
    branches:
      - main
      - develop

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'
  RAILWAY_URL: 'https://theofficeapi-production-5d8f.up.railway.app'

jobs:
  # Job 1: Check CI Status
  check-ci-status:
    runs-on: ubuntu-latest
    name: Check CI Status
    
    steps:
      - name: Check if CI passed
        if: github.event.workflow_run.conclusion != 'success'
        run: |
          echo "FAILED: CI pipeline failed - skipping deployment verification"
          exit 1

      - name: CI passed
        run: |
          echo "SUCCESS: CI pipeline passed"
          echo "Railway will auto-deploy from GitHub integration"

  # Job 2: Wait for Railway Auto-Deployment
  wait-for-deployment:
    runs-on: ubuntu-latest
    name: Wait for Railway Deployment
    needs: check-ci-status
    
    steps:
      - name: Wait for Railway to deploy
        run: |
          echo "Waiting for Railway to auto-deploy from GitHub..."
          echo "This usually takes 2-3 minutes"
          sleep 120

  # Job 3: Health Check
  health-check:
    runs-on: ubuntu-latest
    name: Health Check
    needs: wait-for-deployment
    
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check API liveness
        run: |
          echo "Checking API liveness probe..."

          success=false
          for i in {1..15}; do
            # Try all version endpoints since we don't know which MATURITY_LEVEL is deployed
            for version in v0 v1 v2 v3; do
              if curl -f -s "${{ env.RAILWAY_URL }}/api/$version/health/live" > /dev/null 2>&1; then
                echo "SUCCESS: API is alive via /api/$version/health/live (attempt $i)"
                success=true
                break 2
              fi
            done
            echo "Waiting for API liveness... (attempt $i/15)"
            sleep 10
          done

          if [ "$success" = false ]; then
            echo "FAILED: Liveness check failed - API not responding after 2.5 minutes"
            exit 1
          fi

      - name: Check API readiness
        run: |
          echo "Checking API readiness probe..."

          # Try all version endpoints to check readiness
          readiness_found=false
          for version in v0 v1 v2 v3; do
            if response=$(curl -f -s "${{ env.RAILWAY_URL }}/api/$version/health/ready" 2>&1); then
              echo "SUCCESS: API is ready via /api/$version/health/ready"
              echo "Response: $response"
              readiness_found=true
              break
            fi
          done

          if [ "$readiness_found" = false ]; then
            echo "WARNING: Readiness check endpoint not responding, but continuing..."
          fi

      - name: Verify Swagger endpoints
        run: |
          echo "Verifying Swagger endpoints..."

          if curl -f -s "${{ env.RAILWAY_URL }}/swagger/index.html" > /dev/null; then
            echo "SUCCESS: Swagger UI is accessible"
          else
            echo "FAILED: Swagger UI is not accessible"
            exit 1
          fi

          # Check for any available Swagger version (v0, v1, or v2)
          swagger_found=false
          for version in v0 v1 v2; do
            if curl -f -s "${{ env.RAILWAY_URL }}/swagger/$version/swagger.json" | jq . > /dev/null 2>&1; then
              echo "SUCCESS: Swagger JSON $version is valid"
              swagger_found=true
              break
            fi
          done

          if [ "$swagger_found" = false ]; then
            echo "FAILED: No valid Swagger JSON found (tried v0, v1, v2)"
            exit 1
          fi

          echo ""
          echo "Health check passed!"

  # Job 4: End-to-End Tests
  e2e-tests:
    runs-on: ubuntu-latest
    name: End-to-End Tests
    needs: health-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore TheOfficeAPI.sln

      - name: Build solution
        run: dotnet build TheOfficeAPI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run E2E tests against deployed API
        run: |
          dotnet test tests/TheOfficeAPI.Tests.E2E/TheOfficeAPI.Tests.E2E.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --filter "Category=E2E"
        env:
          API_BASE_URL: ${{ env.RAILWAY_URL }}

      - name: Publish E2E test results
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: E2E Test Results
          path: '**/*.trx'
          reporter: dotnet-trx

  # Job 5: Live Integration Tests
  live-integration-tests:
    runs-on: ubuntu-latest
    name: Live Integration Tests
    needs: health-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore TheOfficeAPI.sln

      - name: Build solution
        run: dotnet build TheOfficeAPI.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Run health check integration tests
        run: dotnet test tests/TheOfficeAPI.Level0.Tests.Integration/TheOfficeAPI.Level0.Tests.Integration.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --filter "Category=HealthCheck"
        env:
          ASPNETCORE_ENVIRONMENT: Production
          API_BASE_URL: ${{ env.RAILWAY_URL }}
        continue-on-error: true

      - name: Run documentation integration tests
        run: dotnet test tests/TheOfficeAPI.Level0.Tests.Integration/TheOfficeAPI.Level0.Tests.Integration.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger trx --filter "Category=Documentation"
        env:
          ASPNETCORE_ENVIRONMENT: Production
          API_BASE_URL: ${{ env.RAILWAY_URL }}
        continue-on-error: true

      - name: Publish live integration test results
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Live Integration Test Results
          path: '**/*.trx'
          reporter: dotnet-trx

  # Job 6: Smoke Tests
  smoke-tests:
    runs-on: ubuntu-latest
    name: Smoke Tests
    needs: health-check
    
    steps:
      - name: Test API endpoints
        run: |
          echo "Running smoke tests on Railway API..."

          echo "Testing /swagger..."
          curl -f -s "${{ env.RAILWAY_URL }}/swagger/index.html" > /dev/null || exit 1
          echo "SUCCESS: Swagger UI works"

          # Check for any available Swagger version (v0, v1, or v2)
          swagger_found=false
          for version in v0 v1 v2; do
            if curl -f -s "${{ env.RAILWAY_URL }}/swagger/$version/swagger.json" > /dev/null 2>&1; then
              echo "SUCCESS: Swagger JSON $version works"
              swagger_found=true
              break
            fi
          done

          if [ "$swagger_found" = false ]; then
            echo "FAILED: No valid Swagger JSON found (tried v0, v1, v2)"
            exit 1
          fi

          echo ""
          echo "All smoke tests passed!"

  # Job 7: CD Summary
  cd-summary:
    runs-on: ubuntu-latest
    name: CD Summary
    needs: [check-ci-status, wait-for-deployment, health-check, e2e-tests, live-integration-tests, smoke-tests]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.smoke-tests.result == 'success' && needs.e2e-tests.result == 'success'
        run: |
          echo "=================================================="
          echo "CD Pipeline - Deployment Verification Successful!"
          echo "=================================================="
          echo ""
          echo "Railway Auto-Deployment: SUCCESS"
          echo "Health Check: PASSED"
          echo "E2E Tests: PASSED"
          echo "Live Integration Tests: PASSED"
          echo "Smoke Tests: PASSED"
          echo ""
          echo "Live API: ${{ env.RAILWAY_URL }}/swagger"
          echo "Swagger UI: ${{ env.RAILWAY_URL }}/swagger"
          echo "OpenAPI Spec: ${{ env.RAILWAY_URL }}/swagger/v{0|1|2}/swagger.json (depends on MATURITY_LEVEL)"
          echo ""
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Deployment Failure
        if: |
          needs.health-check.result == 'failure' ||
          needs.e2e-tests.result == 'failure' ||
          needs.live-integration-tests.result == 'failure' ||
          needs.smoke-tests.result == 'failure'
        run: |
          echo "=================================================="
          echo "CD Pipeline - Deployment Verification Failed!"
          echo "=================================================="
          echo ""
          echo "Failed stages:"
          [ "${{ needs.health-check.result }}" == "failure" ] && echo "FAILED: Health Check"
          [ "${{ needs.e2e-tests.result }}" == "failure" ] && echo "FAILED: E2E Tests"
          [ "${{ needs.live-integration-tests.result }}" == "failure" ] && echo "FAILED: Live Integration Tests"
          [ "${{ needs.smoke-tests.result }}" == "failure" ] && echo "FAILED: Smoke Tests"
          echo ""
          echo "Check Railway deployment logs for details"
          exit 1